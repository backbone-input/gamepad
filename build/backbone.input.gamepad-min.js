!function(t){if("function"==typeof define&&define.amd)define("backbone.input.gamepad",["jquery","underscore","backbone"],t);else if("object"==typeof module&&module&&"object"==typeof module.exports)module.exports=t;else{var e=window.jQuery||window.Zepto||window.vQuery;t(e,window._,window.Backbone)}}(function(t,e,n){var a,i=i||window.APP||null,o=null!==i,r=o&&"undefined"!=typeof i.View?i.View:n.View,s=o&&"undefined"!=typeof i.Layout?i.Layout:!1,d=navigator.getGamepads||navigator.webkitGamepads||navigator.webkitGetGamepads||!1,p=["Button_1","Button_2","Button_3","Button_4","LeftShoulder","RightShoulder","LeftTrigger","RightTrigger","Back","Start","LeftThumbstick","RightThumbstick","DPad_Up","DPad_Down","DPad_Left","DPad_Right","Home"],u=function(t,e,n){return e<t.length?t[e]:n+(e-t.length+1)},c=r.prototype.params||new n.Model;c.set({gamepadButtons:[]});var m=r.prototype.params||new n.Model;m.set({gamepads:{}});var l={countGamepads:function(){var t=this.params.get("gamepads");return Object.keys(t).length},monitorGamepad:function(t){"undefined"==typeof t&&(t=!0),t&&d?(window.addEventListener("gamepadconnected",e.bind(this._onGamepadConnect,this),!1),window.addEventListener("gamepaddisconnected",e.bind(this._onGamepadDisconnect,this),!1),a=setInterval(e.bind(this._scanGamepads,this),500),this.trigger("monitor-gamepad-on")):(window.removeEventListener("gamepadconnected",e.bind(this._onGamepadConnect,this),!1),window.removeEventListener("gamepaddisconnected",e.bind(this._onGamepadDisconnect,this),!1),clearInterval(a),this.trigger("monitor-gamepad-off"))},onGamepadClick:function(){},onGamepadConnect:function(){},onGamepadDisconnect:function(){},_onGamepadConnect:function(t){var n=e.inArray("gamepad",this.options.monitor);if(!n)return this.monitorGamepad(!1);var a=t.gamepad||t.detail.gamepad;t.detail&&(t.gamepad=t.detail.gamepad),e.inDebug()&&console.log("connect",t),t.stopPropagation&&t.stopPropagation();var i=this.params.get("gamepads");return i[a.index]=a,this.params.set({gamepads:i}),this.trigger("gamepad-connect",{originalEvent:t}),this.onGamepadConnect(t)},_onGamepadDisconnect:function(t){var n=e.inArray("gamepad",this.options.monitor);if(!n)return this.monitorGamepad(!1);e.inDebug()&&console.log("disconnect",t),t.stopPropagation&&t.stopPropagation();var a=this.params.get("gamepads");return delete a[t.gamepad.index],this.params.set({gamepads:a}),this.trigger("gamepad-disconnect",{originalEvent:t}),this.onGamepadDisconnect(t)},_scanGamepads:function(){for(var t=d.call(navigator),e=this.params.get("gamepads"),n=0;n<t.length;n++)if(t[n])if(t[n].index in e)e[t[n].index]=t[n];else{var a=new CustomEvent("gamepadconnected",{detail:{gamepad:t[n]}});window.dispatchEvent(a)}this.params.set({gamepads:e})},_updateGamepads:function(t){var n=e.inArray("gamepad",this.options.monitor);return n?(this.trigger("updateGamepads",t),this.updateGamepads&&this.updateGamepads(t),void v.call(window,e.bind(this._updateGamepads,this))):this.monitorGamepad(!1)},_buttonKey:function(t,e){e=e||"xbox";var n=mapping[e].index[t];return p[n]},getType:function(){return"WebKit"},listButtons:function(t){for(var e=0;e<t.buttons.length;e++){var n,a,i=t.buttons[e];"object"==typeof i?(n=i.pressed,a=i.value):(a=i,n=1==i)}},_resolveControllerType:function(t){return t=t.toLowerCase().replace(/\s+/g," ").replace(/^\s+|\s+$/g,""),-1!==t.indexOf("playstation")?h.Type.PLAYSTATION:-1!==t.indexOf("logitech")||-1!==t.indexOf("wireless gamepad")?h.Type.LOGITECH:-1!==t.indexOf("xbox")||-1!==t.indexOf("360")?h.Type.XBOX:-1!==t.indexOf("79-6-generic")&&-1!==t.indexOf("joystick")||-1!==t.indexOf("vendor: 0079 product: 0006")&&-1!==t.indexOf("generic usb joystick")?h.Type.N64:h.Type.UNKNOWN}},f=function(){};f.prototype._connect=function(t){var e,n,a=this._resolveMapping(t);for(t.state={},t.lastState={},t.updater=[],e=a.buttons.byButton.length,n=0;e>n;n++)this._addButtonUpdater(t,a,n);for(e=a.axes.byAxis.length,n=0;e>n;n++)this._addAxisUpdater(t,a,n);this.gamepads[t.index]=t,this._fire(h.Event.CONNECTED,t)},f.prototype._addButtonUpdater=function(t,e,n){var a=nullFunction,i=u(h.StandardButtons,n,"EXTRA_BUTTON_"),o=this._createButtonGetter(t,e.buttons,n),r=this,s={gamepad:t,control:i};t.state[i]=0,t.lastState[i]=0,a=function(){var e=o(),n=t.lastState[i],a=e>.5,d=n>.5;t.state[i]=e,a&&!d?r._fire(h.Event.BUTTON_DOWN,Object.create(s)):!a&&d&&r._fire(h.Event.BUTTON_UP,Object.create(s)),0!==e&&1!==e&&e!==n&&r._fireAxisChangedEvent(t,i,e),t.lastState[i]=e},t.updater.push(a)},f.prototype._addAxisUpdater=function(t,e,n){var a=nullFunction,i=u(h.StandardAxes,n,"EXTRA_AXIS_"),o=this._createAxisGetter(t,e.axes,n),r=this;t.state[i]=0,t.lastState[i]=0,a=function(){var e=o(),n=t.lastState[i];t.state[i]=e,e!==n&&r._fireAxisChangedEvent(t,i,e),t.lastState[i]=e},t.updater.push(a)},f.prototype._fireAxisChangedEvent=function(t,e,n){var a={gamepad:t,axis:e,value:n};this._fire(h.Event.AXIS_CHANGED,a)},f.prototype._createButtonGetter=function(){var t=function(){return 0},e=function(e,n,a){var i=t;return a>n?i=function(){var t=a-n,i=e();return i=(i-n)/t,0>i?0:i}:n>a&&(i=function(){var t=n-a,i=e();return i=(i-a)/t,i>1?0:1-i}),i},n=function(t){return"[object Array]"===Object.prototype.toString.call(t)};return function(a,i,o){var r,s=t,d=this;return r=i.byButton[o],-1!==r?"number"==typeof r&&r<a.buttons.length&&(s=function(){var t=a.buttons[r];return"number"==typeof t?t:"number"==typeof t.value?t.value:0}):i.byAxis&&o<i.byAxis.length&&(r=i.byAxis[o],n(r)&&3==r.length&&r[0]<a.axes.length&&(s=function(){var t=a.axes[r[0]];return d._applyDeadzoneMaximize(t)},s=e(s,r[1],r[2]))),s}}(),f.prototype._createAxisGetter=function(){var t=function(){return 0};return function(e,n,a){var i,o=t,r=this;return i=n.byAxis[a],-1!==i&&"number"==typeof i&&i<e.axes.length&&(o=function(){var t=e.axes[i];return r._applyDeadzoneMaximize(t)}),o}}(),f.prototype._resolveMapping=function(t){var e,n,a=h.Mappings,i=null,o={platform:this.platform.getType(),type:this._resolveControllerType(t.id)};for(e=0;!i&&e<a.length;e++)n=a[e],h.envMatchesFilter(n.env,o)&&(i=n);return i||h.StandardMapping},f.prototype._applyDeadzoneMaximize=function(t,e,n){return e="undefined"!=typeof e?e:this.deadzone,n="undefined"!=typeof n?n:this.maximizeThreshold,t>=0?e>t?t=0:t>n&&(t=1):t>-e?t=0:-n>t&&(t=-1),t};var g,h=r.extend(e.extend({},l,{options:{monitor:[]},params:m.clone(),state:c.clone(),initialize:function(t){return t=t||{},e.bindAll(this,"onGamepadClick"),t.monitor&&e.extend(this.options.monitor,t.monitor),e.inArray("gamepad",this.options.monitor)&&(this.monitorGamepad(),v(e.bind(this._updateGamepads,this)),this.on("gamepadclick",this.onGamepadClick)),h.__super__.initialize.call(this,t)}}));s&&(g=s.extend(e.extend({},l,{options:{monitor:[]},params:m,state:c.clone(),initialize:function(t){return t=t||{},t.monitor&&e.extend(this.options.monitor,t.monitor),e.inArray("gamepad",this.options.monitor)&&(this.monitorGamepad(),v(e.bind(this._updateGamepads,this)),this.on("gamepadclick",this.onClickGamepad)),g.__super__.initialize.call(this,t)}}))),e.mixin({inArray:function(t,e){return e instanceof Array?e.indexOf(t)>-1:!1},inDebug:function(){return"undefined"!=typeof DEBUG&&DEBUG}});var v=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame;return n.Input=n.Input||{},n.Input.Gamepad=h,o&&(i.Input=i.Input||{},i.Input.Gamepad=h),"object"==typeof window&&"object"==typeof window.document&&(window.Backbone=n,o&&(window.APP=i)),h});